<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sentinel | Mission Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="bg-fixed-layer"></div>
    <div class="grid-overlay"></div>

    <script>
        if (!localStorage.getItem("proctor_auth_token")) { window.location.href = "/"; }
    </script>

    <div class="container">
        <header class="flex-between">
            <div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 40px; height: 40px; background: rgba(99, 102, 241, 0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--primary);">
                        <ion-icon name="scan-outline" style="font-size: 1.5rem;"></ion-icon>
                    </div>
                    <h1 class="brand-text" style="font-size: 1.8rem;">SENTINEL</h1>
                </div>
                <p class="subtitle" style="margin-left: 52px;">Live Integrity Monitoring System</p>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <div class="badge badge-success" id="server-status" style="padding: 8px 16px;">
                    <div class="dot"></div> Online
                </div>
                <button onclick="logout()" class="btn-secondary" style="color: var(--danger); border-color: rgba(244, 63, 94, 0.3);">
                    Log Out
                </button>
            </div>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-label">Active Candidates</div>
                <div class="stat-value" id="count-active">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="color: var(--danger);">‚ö†Ô∏è</div>
                <div class="stat-label">Violations Detected</div>
                <div class="stat-value" id="count-violations" style="color: #fb7185; text-shadow: 0 0 20px rgba(244, 63, 94, 0.3);">0</div>
            </div>
            </div>

        <div class="glass-panel table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th width="25%">Candidate</th>
                        <th width="10%">Roll No</th>
                        <th width="15%">SAP ID</th>
                        <th width="15%">Started At</th>
                        <th width="15%">End Time</th> 
                        <th width="20%">Live Status</th>
                    </tr>
                </thead>
                <tbody id="student-table">
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const socket = io();
        let currentStudents = [];
        
        // REMOVED: setInterval logic for session timer

        socket.on('update-dashboard', (students) => {
            currentStudents = students;
            renderTable();
            updateStats();
        });

        function updateStats() {
            const activeCount = currentStudents.filter(s => s.endTime === '-').length;
            document.getElementById('count-active').innerText = activeCount;
            let vCount = 0;
            currentStudents.forEach(s => vCount += s.logs.length);
            document.getElementById('count-violations').innerText = vCount;
        }

        function renderTable() {
            const tbody = document.getElementById('student-table');
            tbody.innerHTML = '';
            if (currentStudents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 60px; color: var(--text-muted);">Waiting for candidates...</td></tr>';
                return;
            }
            currentStudents.forEach((student, index) => {
                const initials = student.name.substring(0,2).toUpperCase();
                const isWeb = student.name.includes("(WEB)");
                let badgeClass = "badge-success";
                let statusText = "Clean Record";
                if (student.riskScore && student.riskScore.includes("VIOLATION")) {
                    badgeClass = "badge-danger"; statusText = "Actively Cheating"; 
                } else if (student.logs.length > 0) {
                    badgeClass = "badge-warning"; statusText = `Flagged (${student.logs.length})`;
                }
                if (student.endTime !== '-') {
                    badgeClass = "badge-neutral"; statusText = student.logs.length > 0 ? `Finished (Flagged)` : "Finished (Clean)";
                }
                let endTimeDisplay = student.endTime === '-' 
                    ? `<span style="color:#34d399; font-weight:600; font-size:0.9rem; text-shadow: 0 0 10px rgba(52, 211, 153, 0.4);">‚óè Online</span>` 
                    : `<span style="font-family: monospace; color:var(--text-muted);">${student.endTime}</span>`;
                const row = `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div class="avatar">${initials}</div>
                            <div>
                                <div style="font-weight: 600; cursor:pointer; color: white; transition: color 0.2s;" onmouseover="this.style.color='var(--primary)'" onmouseout="this.style.color='white'" onclick="viewCandidate(${index})">${student.name}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${isWeb ? 'Browser' : 'App'}</div>
                            </div>
                        </div>
                    </td>
                    <td style="font-family: monospace; color: var(--text-muted);">${student.roll}</td>
                    <td style="font-family: monospace; color: var(--text-muted);">${student.sap}</td>
                    <td style="font-family: monospace;">${student.startTime}</td>
                    <td>${endTimeDisplay}</td> 
                    <td><div class="badge ${badgeClass}"><div class="dot"></div> ${statusText}</div></td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        function viewCandidate(index) {
            const student = currentStudents[index];
            localStorage.setItem('view_candidate_data', JSON.stringify(student));
            window.location.href = '/candidate.html';
        }
        function logout() {
            if(confirm("Securely log out?")) {
                localStorage.removeItem("proctor_auth_token");
                window.location.href = "/";
            }
        }
    </script>
</body>
</html>