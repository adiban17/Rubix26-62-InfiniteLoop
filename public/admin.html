<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sentinel | Mission Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Fira+Code&display=swap" rel="stylesheet">
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="bg-fixed-layer"></div>
    <div class="grid-overlay"></div>

    <script>
        if (!localStorage.getItem("proctor_auth_token")) { window.location.href = "/"; }
    </script>

    <div class="container">
        <header class="flex-between">
            <div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 40px; height: 40px; background: rgba(99, 102, 241, 0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--primary);">
                        <ion-icon name="scan-outline" style="font-size: 1.5rem;"></ion-icon>
                    </div>
                    <h1 class="brand-text" style="font-size: 1.8rem;">SENTINEL</h1>
                </div>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <button onclick="logout()" class="btn-secondary" style="color: var(--danger); border-color: rgba(244, 63, 94, 0.3);">
                    Log Out
                </button>
            </div>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-label">Active Candidates</div>
                <div class="stat-value" id="count-active">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="color: var(--danger);">‚ö†Ô∏è</div>
                <div class="stat-label">High Risk (>70%)</div>
                <div class="stat-value" id="count-violations" style="color: #fb7185; text-shadow: 0 0 20px rgba(244, 63, 94, 0.3);">0</div>
            </div>
        </div>

        <div class="glass-panel table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th width="30%">Candidate</th>
                        <th width="15%">Roll No</th>
                        <th width="15%">SAP ID</th>
                        <th width="15%">Max Risk</th> <th width="25%">Live Status</th> 
                    </tr>
                </thead>
                <tbody id="student-table">
                </tbody>
            </table>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentStudents = [];
        
        socket.on('update-dashboard', (students) => {
            currentStudents = students;
            renderTable();
            updateStats();
        });

        function updateStats() {
            const activeCount = currentStudents.filter(s => s.endTime === '-').length;
            document.getElementById('count-active').innerText = activeCount;
            
            // FIX: Count based on PEAK risk (history), not live risk
            const highRiskCount = currentStudents.filter(s => (s.peakRisk || 0) > 70).length;
            document.getElementById('count-violations').innerText = highRiskCount;
        }

        function renderTable() {
            const tbody = document.getElementById('student-table');
            tbody.innerHTML = '';
            if (currentStudents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 60px; color: var(--text-muted);">Waiting for candidates...</td></tr>';
                return;
            }
            currentStudents.forEach((student, index) => {
                const initials = student.name ? student.name.substring(0,2).toUpperCase() : "--";
                
                let badgeClass = "badge-success";
                let statusText = "Live & Safe";
                const isOnline = student.endTime === '-';

                // Live Status Logic
                if (student.status && student.status.includes("VIOLATION")) {
                    badgeClass = "badge-danger";
                    statusText = student.status.replace("VIOLATION:", "").trim(); 
                } else if (!isOnline) {
                    badgeClass = "badge-neutral"; 
                    statusText = "Completed"; 
                }

                // FIX: Use peakRisk for the "Max Risk" column
                const maxScore = student.peakRisk || 0;
                
                let riskColor = "#34d399"; // Green
                if(maxScore >= 40) riskColor = "#facc15"; // Yellow
                if(maxScore >= 75) riskColor = "#f43f5e"; // Red

                // Only show Online indicator if strictly online
                const onlineIndicator = isOnline ? `<div class="dot" style="background: ${riskColor}"></div>` : '';

                const row = `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div class="avatar">${initials}</div>
                            <div style="font-weight: 600; cursor:pointer;" onclick="viewCandidate(${index})">${student.name}</div>
                        </div>
                    </td>
                    <td style="font-family: monospace; color: var(--text-muted);">${student.roll}</td>
                    <td style="font-family: monospace; color: var(--text-muted);">${student.sap}</td>
                    
                    <td style="font-family: 'Fira Code', monospace; font-weight: bold; color: ${riskColor}; font-size: 1.1rem;">
                        ${maxScore}%
                    </td>
                    
                    <td>
                        <div class="badge ${badgeClass}">
                            ${onlineIndicator} ${statusText}
                        </div>
                    </td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        function viewCandidate(index) {
            const student = currentStudents[index];
            localStorage.setItem('view_candidate_data', JSON.stringify(student));
            window.location.href = '/candidate.html';
        }
        function logout() {
            if(confirm("Log out?")) {
                localStorage.removeItem("proctor_auth_token");
                window.location.href = "/";
            }
        }
    </script>
</body>
</html>