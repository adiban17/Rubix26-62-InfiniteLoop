<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ProctorHQ | Mission Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="bg-fixed-layer"></div>
    <div class="grid-overlay"></div>

    <script>
        if (!localStorage.getItem("proctor_auth_token")) {
            window.location.href = "/";
        }
    </script>

    <div class="container">
        <header class="flex-between">
            <div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 1.5rem;">üõ°Ô∏è</span>
                    <h1>ProctorHQ Monitor</h1>
                </div>
                <p class="subtitle" style="margin-left: 44px;">Real-time exam surveillance & integrity system</p>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <div class="badge badge-success" id="server-status" style="padding: 8px 16px;">
                    <div class="dot"></div> System Online
                </div>
                <button onclick="logout()" class="btn-secondary" style="color: var(--danger); border-color: rgba(244, 63, 94, 0.3); width: auto; padding: 8px 20px;">
                    Log Out
                </button>
            </div>
        </header>

        <div class="stats-grid">
            <div class="stat-card glass-panel">
                <div class="stat-icon">üë•</div>
                <div class="stat-label">Active Candidates</div>
                <div class="stat-value" id="count-active">0</div>
            </div>
            <div class="stat-card glass-panel">
                <div class="stat-icon" style="color: var(--danger);">‚ö†Ô∏è</div>
                <div class="stat-label">Total Violations</div>
                <div class="stat-value" id="count-violations" style="color: #fb7185; text-shadow: 0 0 20px rgba(244, 63, 94, 0.3);">0</div>
            </div>
            <div class="stat-card glass-panel">
                <div class="stat-icon">‚è±Ô∏è</div>
                <div class="stat-label">Session Time</div>
                <div class="stat-value" id="session-time" style="font-variant-numeric: tabular-nums;">00:00</div>
            </div>
        </div>

        <div class="glass-panel table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th width="25%">Candidate</th>
                        <th width="10%">Roll No</th>
                        <th width="15%">SAP ID</th>
                        <th width="15%">Started At</th>
                        <th width="15%">End Time</th> 
                        <th width="20%">Live Status</th>
                    </tr>
                </thead>
                <tbody id="student-table">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="logModal" class="modal-overlay" style="display: none; place-items: center; position: fixed; inset: 0; z-index: 50;">
        <div class="glass-panel modal-card" style="width: 100%; max-width: 500px; padding: 30px;">
            <div class="flex-between" style="margin-bottom: 20px;">
                <h2 style="font-size: 1.25rem; font-weight: 700; color: white;">Activity Logs</h2>
                <button onclick="closeModal()" style="background:none; border:none; font-size:1.8rem; cursor:pointer; color:var(--text-muted);">&times;</button>
            </div>
            <div id="logList" style="background: rgba(0,0,0,0.3); border-radius: 12px; padding: 15px; max-height: 300px; overflow-y: auto; border: 1px solid var(--glass-border);">
            </div>
            <button onclick="downloadLogs()" class="btn-primary" style="margin-top: 20px;">
                Download Evidence Report
            </button>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const socket = io();
        let currentStudents = [];
        let selectedStudent = null;
        
        let seconds = 0;
        setInterval(() => {
            seconds++;
            const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
            const secs = (seconds % 60).toString().padStart(2, '0');
            document.getElementById('session-time').innerText = `${mins}:${secs}`;
        }, 1000);

        socket.on('update-dashboard', (students) => {
            currentStudents = students;
            renderTable();
            updateStats();
        });

        function updateStats() {
            const activeCount = currentStudents.filter(s => s.endTime === '-').length;
            document.getElementById('count-active').innerText = activeCount;
            
            let vCount = 0;
            currentStudents.forEach(s => vCount += s.logs.length);
            document.getElementById('count-violations').innerText = vCount;
        }

        function renderTable() {
            const tbody = document.getElementById('student-table');
            tbody.innerHTML = '';

            if (currentStudents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 60px; color: var(--text-muted);">Waiting for candidates to join...</td></tr>';
                return;
            }

            currentStudents.forEach((student, index) => {
                const initials = student.name.substring(0,2).toUpperCase();
                const isWeb = student.name.includes("(WEB)");
                
                let badgeClass = "badge-success";
                let statusText = "Clean Record";

                if (student.riskScore && student.riskScore.includes("VIOLATION")) {
                    badgeClass = "badge-danger";
                    statusText = "Actively Cheating"; 
                } 
                else if (student.logs.length > 0) {
                    badgeClass = "badge-warning";
                    statusText = `Flagged (${student.logs.length})`;
                }

                if (student.endTime !== '-') {
                    badgeClass = "badge-neutral";
                    statusText = student.logs.length > 0 ? `Finished (Flagged)` : "Finished (Clean)";
                }

                let endTimeDisplay = student.endTime === '-' 
                    ? `<span style="color:#34d399; font-weight:600; font-size:0.9rem; text-shadow: 0 0 10px rgba(52, 211, 153, 0.4);">‚óè Online</span>` 
                    : `<span style="font-family: monospace; color:var(--text-muted);">${student.endTime}</span>`;

                const row = `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div class="avatar">${initials}</div>
                            <div>
                                <div style="font-weight: 600; cursor:pointer; color: white; transition: color 0.2s;" onmouseover="this.style.color='var(--primary)'" onmouseout="this.style.color='white'" onclick="openModal(${index})">${student.name}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${isWeb ? 'Browser Client' : 'Secure App Client'}</div>
                            </div>
                        </div>
                    </td>
                    <td style="font-family: monospace; color: var(--text-muted);">${student.roll}</td>
                    <td style="font-family: monospace; color: var(--text-muted);">${student.sap}</td>
                    <td style="font-family: monospace;">${student.startTime}</td>
                    <td>${endTimeDisplay}</td> 
                    <td>
                        <div class="badge ${badgeClass}">
                            <div class="dot"></div> ${statusText}
                        </div>
                    </td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        function logout() {
            if(confirm("Securely log out?")) {
                localStorage.removeItem("proctor_auth_token");
                window.location.href = "/";
            }
        }

        function openModal(index) {
            selectedStudent = currentStudents[index];
            const list = document.getElementById('logList');
            list.innerHTML = '';
            
            if(selectedStudent.logs.length === 0) {
                list.innerHTML = '<div style="text-align:center; color: var(--text-muted); padding: 20px;">No violations recorded.</div>';
            } else {
                selectedStudent.logs.forEach(log => {
                    list.innerHTML += `
                    <div style="border-bottom:1px solid var(--glass-border); padding: 12px 0; font-size: 0.9rem;">
                        <span style="color:#fb7185; font-weight:600;">${log.violation}</span>
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-top:4px;">${log.time}</div>
                    </div>`;
                });
            }
            document.getElementById('logModal').style.display = 'grid';
        }

        function closeModal() { document.getElementById('logModal').style.display = 'none'; }
        
        function downloadLogs() {
            if(!selectedStudent) return;
            let content = `Exam Report: ${selectedStudent.name}\nGenerated: ${new Date().toLocaleString()}\n--------------------------------\n`;
            if(selectedStudent.logs.length === 0) content += "No Violations.";
            else selectedStudent.logs.forEach(l => content += `[${l.time}] ${l.violation}\n`);
            
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([content], {type:'text/plain'}));
            a.download = `${selectedStudent.name}_Report.txt`;
            a.click();
        }
        
        window.onclick = function(e) { if(e.target == document.getElementById('logModal')) closeModal(); }
    </script>
</body>
</html>